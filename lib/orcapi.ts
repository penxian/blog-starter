const AK = process.env.AK
const SK = process.env.SK

export type Token = {
  accessToken: string,
  expires: number
}

let token: Token = {
  accessToken: '',
  expires: Date.now()
};

export async function fetchToken(): Promise<Token> {
  const options = {
    'method': 'GET',
    'headers': {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    }
  };
  const url = `https://aip.baidubce.com/oauth/2.0/token?client_id=${AK}&client_secret=${SK}&grant_type=client_credentials`
  const res = await fetch(url, options);
  const jsonData = await res.json()
  console.log(jsonData?.message?.access_token)
  return {
    accessToken: jsonData?.access_token,
    expires: jsonData?.expires_in + Date.now()
  }
}

export async function getToken(): Promise<Token> {
  if (!token.accessToken || Date.now() > token.expires) {
    console.log('token过期, 重新请求token')
    token = await fetchToken()
  }
  return token
}

export async function ocr(params: string) {
  const access_token: Token = await getToken()
  const url = `https://aip.baidubce.com/rest/2.0/ocr/v1/general_basic?access_token=${access_token.accessToken}`;
  const formData = new URLSearchParams({
    'image': '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',
  })
  console.log(formData)
  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'Accept': 'application/json'
    },
    body: formData
  })
  return res.json()
}